#!/bin/sh
#
# lock - Block a website via /etc/hosts
#
# Usage:
#   lock <domain>
#
# Examples:
#   lock x.com
#   lock reddit.com

set -e

# --- Argument parsing ---

if [ -z "$1" ]; then
    echo "Usage: lock <domain>"
    echo ""
    echo "Examples:"
    echo "  lock x.com"
    echo "  lock reddit.com"
    exit 1
fi

DOMAIN="$1"

# Strip protocol/www if the user passed a URL
DOMAIN=$(echo "$DOMAIN" | sed 's|https\?://||' | sed 's|www\.||' | sed 's|/.*||')

LOCK_TAG="# lock: $DOMAIN"

# --- Lock ---

echo "üîí Locking $DOMAIN..."

# Check if already locked
if grep -q "0.0.0.0 $DOMAIN" /etc/hosts 2>/dev/null; then
    echo "‚ÑπÔ∏è  $DOMAIN is already locked"
    exit 0
fi

# Build hosts entries
HOSTS_ENTRIES="$LOCK_TAG
0.0.0.0 $DOMAIN
0.0.0.0 www.$DOMAIN
"

# Add entries to /etc/hosts
echo "$HOSTS_ENTRIES" | sudo tee -a /etc/hosts > /dev/null
echo "‚úÖ Added $DOMAIN to /etc/hosts"

# Flush DNS cache (OS-specific)
if [ "$(uname)" = "Darwin" ]; then
    # macOS
    sudo dscacheutil -flushcache
    sudo killall -HUP mDNSResponder 2>/dev/null || true
    echo "‚úÖ DNS cache flushed"
elif [ "$(uname)" = "Linux" ]; then
    # Linux - varies by system, try common ones
    if command -v systemd-resolve > /dev/null 2>&1; then
        sudo systemd-resolve --flush-caches 2>/dev/null && echo "‚úÖ DNS cache flushed" || true
    elif command -v resolvectl > /dev/null 2>&1; then
        sudo resolvectl flush-caches 2>/dev/null && echo "‚úÖ DNS cache flushed" || true
    else
        echo "‚ÑπÔ∏è  DNS cache flush skipped (no systemd DNS resolver detected)"
        echo "   Restart your browser for changes to take effect"
    fi
else
    echo "‚ÑπÔ∏è  DNS cache flush skipped (unsupported OS: $(uname))"
    echo "   You may need to restart your browser for changes to take effect"
fi

echo ""
echo "üîí $DOMAIN is now blocked"
echo ""
echo "To unlock: sudo nano /etc/hosts (remove the lock entries)"
